# .github/workflows/android_build.yml

name: Android Build with Buildozer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install System Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          python3-pip \
          openjdk-17-jdk \
          git \
          zip \
          unzip \
          autoconf \
          automake \
          libtool \
          pkg-config

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install Cython buildozer

    - name: Setup Android Licenses
      run: |
        mkdir -p ~/.android
        mkdir -p $ANDROID_SDK_ROOT/licenses
        
        # Accept all licenses
        echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo -e "\n504667f4c0de7973335447fc6aedc8a49b14150b" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo -e "\n1d8b82cbbee477f875a3b4aa69433636da6b826a" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        
        # Also create in home directory
        cp $ANDROID_SDK_ROOT/licenses/android-sdk-license ~/.android/
        
        # List to verify
        ls -la $ANDROID_SDK_ROOT/licenses/

    - name: Build APK with Buildozer
      run: buildozer android debug
      timeout-minutes: 120
      env:
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

    - name: Check Build Output
      if: always()
      run: |
        ls -la bin/ || echo "No bin directory"
        find . -name "*.apk" -type f 2>/dev/null || echo "No APK found"

    - name: Upload APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: english-word-quiz-apk
        path: bin/*.apk
        retention-days: 30

    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          .buildozer/
        retention-days: 7